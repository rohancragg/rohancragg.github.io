



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
    <meta property="og:title" content="Patching in DevTest Labs"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="/compute/patching-devtestlabs/"/>

    <meta property="og:image" content="/compute/media/media/dtl.png"/>

    <meta property="og:locale" content="en-GB"/>

    <meta property="base_url" content="../.." />
    <meta property="site_url" content="" />
    <meta property="page.url" content="compute/patching-devtestlabs/" />
    <meta property="page.abs_url" content="/compute/patching-devtestlabs/" />
    <meta property="page.canonical_url" content="https://rohancragg.co.uk/compute/patching-devtestlabs/" />
    <meta property="page.parent" content="Section(title='DevOps')" />
    <meta property="link" content="" />

    
      
        <title>VM Patching in DevTest Labs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#7e57c2">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="manifest" type="application/manifest+json" href="../../manifest.webmanifest" crossorigin="use-credentials">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#about-devtest-labs" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rohancragg.co.uk" title="What I learned today (@rohancragg)" aria-label="What I learned today (@rohancragg)" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              What I learned today (@rohancragg)
            </span>
            <span class="md-header-nav__topic">
              
                VM Patching in DevTest Labs
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/rohancragg/blog-notes/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    rohancragg/blog-notes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
          


  

<div class="md-hero md-hero--expand" data-md-component="hero">
  <div class="md-hero__inner md-grid">
    Keeping Virtual Machines Patched (DevTest Labs edition)
  </div>
</div>
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rohancragg.co.uk" title="What I learned today (@rohancragg)" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    What I learned today (@rohancragg)
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/rohancragg/blog-notes/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    rohancragg/blog-notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About Me" class="md-nav__link">
      About Me
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tools & Techniques
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Tools & Techniques
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/scoop/" title="Scoop & Co" class="md-nav__link">
      Scoop & Co
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/git-bash/" title="Bash Shell on Windows" class="md-nav__link">
      Bash Shell on Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/misc/" title="Miscellanous Notes" class="md-nav__link">
      Miscellanous Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      DevOps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        DevOps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../devops/azdo-self-hosted-build-agents/" title="Azure DevOps - Self-Hosted Build Agents" class="md-nav__link">
      Azure DevOps - Self-Hosted Build Agents
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        VM Patching in DevTest Labs
      </label>
    
    <a href="./" title="VM Patching in DevTest Labs" class="md-nav__link md-nav__link--active">
      VM Patching in DevTest Labs
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-devtest-labs" class="md-nav__link">
    About DevTest Labs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-environment" class="md-nav__link">
    Secure Environment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools-for-data-science" class="md-nav__link">
    Tools for Data Science
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-automation-update-management" class="md-nav__link">
    Azure Automation - Update Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-pre-and-post-scripts-to-prepare-machines-for-patching" class="md-nav__link">
    Using pre and post-scripts to prepare machines for patching
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Kubernetes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Kubernetes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aks/domains/" title="Clusters and Domains" class="md-nav__link">
      Clusters and Domains
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aks/create-tls-secret/" title="Create a TLS Secret" class="md-nav__link">
      Create a TLS Secret
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-devtest-labs" class="md-nav__link">
    About DevTest Labs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-environment" class="md-nav__link">
    Secure Environment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools-for-data-science" class="md-nav__link">
    Tools for Data Science
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-automation-update-management" class="md-nav__link">
    Azure Automation - Update Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-pre-and-post-scripts-to-prepare-machines-for-patching" class="md-nav__link">
    Using pre and post-scripts to prepare machines for patching
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rohancragg/blog-notes/edit/master/docs/compute/patching-devtestlabs.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>VM Patching in DevTest Labs</h1>
                
                <p>We regularly help our customers to use Azure's <a href="https://docs.microsoft.com/en-us/azure/lab-services/"><strong>DevTest Labs</strong></a>  in combination with <a href="https://azure.microsoft.com/en-us/services/virtual-machines/data-science-virtual-machines/"><strong>Data Science Virtual Machines</strong></a> to safely and securely spin up the required resources for rapid-fire projects without slowing down the pace of innovation and time-to-market for new ideas.</p>
<p>One aspect of providing a secure environment is ensure that machines are regularly patched and operating systems and software kept up to date to limit the risk of vulnerabity to expliots and fix bugs.</p>
<p>At the time of writing, I'm part of a small team supporting a variety of teams in various parts of the business who need access to such environments at short notice and we don't have the time to be patching virtual machines one-by-one on a routine basis. As a result we need to use as much automation as we can to do this for us.</p>
<p>This article is about how we used Azure's Update Management solution to keep Virtual Mchines in DevTest Labs up to date with very little manual intervention from the administrators (<em>that's us!</em>).</p>
<h2 id="about-devtest-labs">About DevTest Labs<a class="headerlink" href="#about-devtest-labs" title="Permanent link">&para;</a></h2>
<p><strong>DevTest Labs (DTL)</strong> enable project team members to self-manage virtual machines (VMs) without waiting for approvals, or for an administrator to create and configure it for them.</p>
<p><img alt="DevTest Labs" src="../media/dtl.png" /></p>
<p>This allows us to offer pre-configured base machines (both Windows and Linux) which have all the necessary tools and software built-in which users can then spin up in just a few minutes.</p>
<h3 id="secure-environment">Secure Environment<a class="headerlink" href="#secure-environment" title="Permanent link">&para;</a></h3>
<p>VMs are made avaiable in a DTL and depending on requirements we typically be protect them as follows:</p>
<ul>
<li>
<p>Placing the VMs into a subnet within a private Virtual Network (VNET) so that a perimeter firewall device can be used to filter and log internet and intra-network access.</p>
</li>
<li>
<p>Applying a User Defined Route (UDR) to ensure that all traffic from the subnet traverses the firewall.</p>
</li>
<li>
<p>The DTL works on our behalf to ensure that each of the virtual machines and its associated resources are deployed into a separate resource group RBAC is used to limit who can change settings or gain access to the virtual machine. The user who has claimed the machine has just enough rights to use it but not modify anything else.</p>
</li>
<li>
<p>Using <a href="https://docs.microsoft.com/en-us/azure/lab-services/add-artifact-vm">DevTest Lab Artifacts</a> to add additional components and configure the operating system and machine policy.</p>
</li>
<li>
<p>Using Azure's <strong>Update Management</strong> solution (see below) to keep operating systems patched. <em>This topic is the main focus of this article.</em></p>
</li>
</ul>
<h2 id="tools-for-data-science">Tools for Data Science<a class="headerlink" href="#tools-for-data-science" title="Permanent link">&para;</a></h2>
<p>Our customers have more and more data and they are asking more a more comlex questions of that data. Developers and Data Scientists are engaged to find the answers and they need to quickly spin up an environment with all the right tools.</p>
<p><img alt="Data Science Virtual Machine" src="../media/dsvm.png" /></p>
<p><a href="https://azure.microsoft.com/en-us/services/virtual-machines/data-science-virtual-machines/">Data Science Virtual Machines</a> (DSVM) are a customized VM image which we typically make available for end-user selection in our DTL environments. These are VMs built specifically for doing data science. They come pre-installed and pre-configured with many popular data science tools which helps to jump-start data engineering and advanced analytics.</p>
<p>The combination of DSVMs and a DevTest Lab Environment is a powerful enabler for people to get started on the job quickly without worrying about precious data assets falling into the wrong hands.</p>
<h2 id="azure-automation-update-management">Azure Automation - Update Management<a class="headerlink" href="#azure-automation-update-management" title="Permanent link">&para;</a></h2>
<p>We use the <a href="https://docs.microsoft.com/en-us/azure/automation/automation-update-management">Update Management</a> solution in <a href="https://docs.microsoft.com/en-us/azure/automation/">Azure Automation</a> to manage operating system updates for virtual machines in our DevTest Labs in Azure.</p>
<p>Update Management scans and displays the status of available updates and it manages the process of installing required updates on each machine on a configurable schedule.</p>
<p>Here's what we needed:</p>
<ul>
<li>
<p>Update Management can only patch a machine whilst it's running</p>
</li>
<li>
<p>Machines are shut down automatically by the DevTest Labs environment out of working hours to save costs and therefore machines are only running during the daytime.</p>
</li>
<li>
<p>We want to limit how much we interrupt a user while they're using their VM so any system maintenance needs to happen out-of-hours.</p>
</li>
</ul>
<p>As such we needed to find a way to ensure that virtual machines were running when the patching process starts but are shut down again afterwards to limit costs.</p>
<h3 id="using-pre-and-post-scripts-to-prepare-machines-for-patching">Using pre and post-scripts to prepare machines for patching<a class="headerlink" href="#using-pre-and-post-scripts-to-prepare-machines-for-patching" title="Permanent link">&para;</a></h3>
<p>Pre-scripts and post-scripts let you run PowerShell runbooks in your Azure Automation account before (pre-task) and after (post-task) a scheduled update management deployment.</p>
<p>The documentation <a href="https://docs.microsoft.com/en-us/azure/automation/pre-post-scripts">'Manage pre and post-scripts'</a> provided us with most of what we needed to know. At time of writing the document does a good job of explaining the general concept of pre and post-scripts using script gallery samples such as <code>UpdateManagement-TurnOnVMS</code> and <code>UpdateManagement-TurnOffVMs</code> as examples of what you can do with these kinds of runbooks. In this article I'll fill in a few gaps in the end-to-end steps we needed to take to get these start/stop scripts working for us as a routine patching solution.</p>
<ul>
<li>
<p><a href="https://www.powershellgallery.com/packages/UpdateManagement-TurnOnVms">UpdateManagement-TurnOnVms</a> - ensures all Azure VMs in the Update Deployment are running so they recieve updates. It stores the names of machines that were started in an Automation variable so only those machines are turned back off (by the accompanying <em>UpdateManagement-TurnOffVms</em> script) when the deployment is finished.</p>
</li>
<li>
<p><a href="https://www.powershellgallery.com/packages/UpdateManagement-TurnOffVms">UpdateManagement-TurnOffVms</a> - ensures that all Azure VMs in the Update Deployment are turned off after they recieve updates by reads the names of the machines from the Automation variable.</p>
</li>
</ul>
<p>Source code for the above modules <a href="https://github.com/zjalexander/UpdateManagement">can be found from <strong>zjalexander</strong> in GitHub</a>.</p>
<p>The ReadMe document in GitHub explains that the scripts have the following requirements, which I'll explain in a bit more detail here.</p>
<ul>
<li>
<p>Follow these links to create an <a href="https://docs.microsoft.com/en-us/azure/automation/automation-quickstart-create-account"><strong>Automation Account</strong></a> and a linked <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-platform-logs"><strong>Log Analytics Workspace</strong></a> with the <a href="https://docs.microsoft.com/en-us/azure/automation/automation-update-management"><strong>Update Management</strong></a> solution enabled.</p>
</li>
<li>
<p>A <strong>RunAs account</strong> for interacting with the Azure services used by these scripts.</p>
<ul>
<li>Follow this document to <a href="https://docs.microsoft.com/en-gb/azure/automation/manage-runas-account#creating-a-run-as-account-in-azure-portal">Create a Run As account</a> either in Azure portal or or with PowerShell. Be aware that you need sufficient privileges (at least Application administrator in Azure Active Directory and an Owner in a subscription) to complete this task.</li>
</ul>
</li>
<li>
<p>The <strong>ThreadJob</strong> module imported into your Automation Account.</p>
<ul>
<li>The UpdateManagement modules both depend on the <a href="https://www.powershellgallery.com/packages/ThreadJob">ThreadJob module</a>. This module extends the existing PowerShell BackgroundJob to include a new thread-based job to provide faster operation with less overhead. To install it<ul>
<li>go to the URL in a browser <a href="https://www.powershellgallery.com/packages/ThreadJob">https://www.powershellgallery.com/packages/ThreadJob</a></li>
<li>click on the 'Azure Automation' tab</li>
<li>click on the button 'Deploy to Azure Automation'</li>
<li>pick the Subscription name, Resource Group and Location and select the Automation Account you want to install the module into.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>The <strong>latest versions of the AzureRM</strong> modules.</p>
<ul>
<li>
<p>In order to <a href="https://docs.microsoft.com/en-gb/azure/automation/automation-update-azure-modules">Update Azure PowerShell modules in Azure Automation</a> need to download the <a href="https://github.com/Microsoft/AzureAutomation-Account-Modules-Update">Update Azure modules runbook</a> from GitHub and import and publish it into the list of Runbooks your Automation Account.</p>
<p><img alt="Import Runbook" src="../media/import-runbook.png" /></p>
</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Top Tip</p>
<p>Rather than download the runbook powershell script from GitHub, you can directly paste the 'raw' file URL from GitHub into the 'Runbook file' textbox i.e. '<a href="https://raw.githubusercontent.com/microsoft/AzureAutomation-Account-Modules-Update/master/Update-AutomationAzureModulesForAccount.ps1">https://raw.githubusercontent.com/microsoft/AzureAutomation-Account-Modules-Update/master/Update-AutomationAzureModulesForAccount.ps1</a>'</p>
</div>
<p>Now you can use the <strong>Runbook Gallery</strong> to import the start-stop scripts as follows:</p>
<ul>
<li>In the Azure portal, open your Automation account</li>
<li>Under Process Automation, click on <strong>Runbooks Gallery</strong></li>
<li>Select <em>'Source: Script Center'</em></li>
<li>Enter 'UpdateManagement' into the search box</li>
<li>select each module and click <strong>'Import'</strong>:<ul>
<li><em>Update Management - Turn On VMs</em></li>
<li><em>Update Management - Turn Off VMs</em></li>
</ul>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Important</p>
<p>After you import runbooks you need to publish them before they can be used. To do this, find the runbook in <strong>Runbooks</strong> pane and click <strong>Edit</strong> and <strong>Publish</strong>.</p>
</div>
<p>Visit the Docs page for details on <a href="https://docs.microsoft.com/en-us/azure/automation/pre-post-scripts#using-a-pre-script-or-post-script">how to use these pre and post-scripts in your update deployment</a>. </p>
<p>Here's what one of my update deployment runs looks like with the script status showing completed:</p>
<p><img alt="Completed update deployment" src="../media/update-deployment-run.png" /></p>
                
                  
                
                
                  
                  <hr>
                  <div class="md-source-date">
                    <small>
                      
                        Last update: 2020-03-31
                      
                    </small>
                  </div>
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://rohancragg.co.uk/compute/patching-devtestlabs/";
      this.page.identifier =
        "/compute/patching-devtestlabs/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//rohancragg.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../devops/azdo-self-hosted-build-agents/" title="Azure DevOps - Self-Hosted Build Agents" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Azure DevOps - Self-Hosted Build Agents
              </span>
            </div>
          </a>
        
        
          <a href="../../aks/domains/" title="Clusters and Domains" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Clusters and Domains
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 - 2020 Rohan Cragg
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://www.linkedin.com/in/rohancragg" target="_blank" rel="noopener" title="linkedin" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://twitter.com/rohancragg" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://github.com/rohancragg" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://fb.com/rohancragg" target="_blank" rel="noopener" title="facebook" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://www.instagram.com/rohancragg/" target="_blank" rel="noopener" title="instagram" class="md-footer-social__link fa fa-instagram"></a>
    
      <a href="https://asciinema.org/~rohancragg" target="_blank" rel="noopener" title="terminal" class="md-footer-social__link fa fa-terminal"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="https://platform.linkedin.com/badges/js/profile.js"></script>
      
    
  </body>
</html>